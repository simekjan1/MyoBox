<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osobní záznamník</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Základní styly pro vysoký kontrast a lepší čitelnost */
        body {
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: #fff;
            padding: 2rem;
        }
        .container {
            max-width: 5xl; /* Větší kontejner pro více obsahu */
            margin: 0 auto;
            padding: 2rem;
            background-color: #1a1a1a;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #facc15;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2rem;
        }
        h2 {
            color: #facc15;
            font-size: 1.75rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #555;
            padding-bottom: 0.5rem;
        }
        /* Styly pro tlačítka */
        button {
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .btn-primary { background-color: #4caf50; color: #fff; } /* Add (zelená) */
        .btn-secondary { background-color: #facc15; color: #000; } /* Edit (NOVÁ ŽLUTÁ) */
        .btn-danger { background-color: #f44336; color: #fff; } /* Remove (červená) */
        .btn-export { background-color: #ff9800; color: #000; } /* Export (oranžová) */
        .btn-import { background-color: #ffc107; color: #000; } /* Import (světle oranžová) */
        .btn-toggle-form { background-color: #6200ea; color: #fff; } /* Toggle forms (fialová) */
        .btn-filter { background-color: #03a9f4; color: #fff; } /* Filter (světle modrá) */
        .btn-back { background-color: #4a4a4a; color: #fff; } /* Back to Dashboard (šedá) */
        
        button:hover { opacity: 0.9; }
        button:focus { outline: 2px solid #facc15; outline-offset: 2px; }

        /* Styly pro formuláře a inputy */
        .form-section {
            background-color: #222;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            padding: 0.75rem;
            width: 100%;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
            box-sizing: border-box; /* Zahrne padding a border do šířky */
        }
        textarea { height: 120px; resize: vertical; } /* Povolí změnu velikosti */
        label { margin-bottom: 0.5rem; display: block; color: #ccc; }
        .hidden { display: none; } /* Pro skrývání prvků */

        /* Styly pro tabulku */
        table {
            border-collapse: collapse;
            width: 100%;
            background: #111;
            color: #fff;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            overflow: hidden; /* Aby se border-radius aplikoval na celou tabulku */
        }
        th, td {
            border: 1px solid #333;
            padding: 0.75rem;
            text-align: left; /* Zarovnání textu vlevo pro lepší čitelnost */
        }
        th {
            background: #222;
            font-weight: bold;
            color: #facc15;
        }
        tr:nth-child(even) { background-color: #1a1a1a; } /* Střídavé barvy řádků */
        tr:hover { background-color: #2a2a2a; } /* Změna barvy při najetí */

        /* Styly pro modální okna */
        .modal {
            background: #111;
            border: 2px solid #facc15; /* Žlutý rámeček */
            padding: 2rem;
            border-radius: 10px;
            color: #fff;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto; /* Pro posouvání obsahu modalu */
            display: none; /* Skryté ve výchozím stavu */
            position: fixed; /* Aby se zobrazilo nad ostatním obsahem */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000; /* Zvýšený z-index */
        }
        .modal h3 {
            color: #facc15;
            margin-top: 0;
            text-align: center;
        }
        .modal button {
            margin-top: 1rem;
            width: auto;
            display: inline-block;
        }
        .modal-text {
            color: #ccc;
            margin-bottom: 1rem;
        }
        .modal-buttons {
            text-align: right;
        }

        /* Specifické styly pro typy úkolů/položek v tabulce */
        .item-type-note { color: #8d8dff; } /* Modrá pro poznámky */
        .item-type-todo_list { color: #4caf50; } /* Zelená pro To-Do listy */
        .item-type-event { color: #ff9800; } /* Oranžová pro události */
        .item-type-idea { color: #f44336; } /* Červená pro nápady */

        /* To-Do specifické styly */
        .todo-completed { text-decoration: line-through; color: #888; }
        .todo-priority-nízká { color: #ccc; }
        .todo-priority-střední { color: #facc15; }
        .todo-priority-vysoká { color: #f44336; font-weight: bold; }
        
        /* Odkaz zpět na Dashboard */
        .back-to-dashboard-link {
            display: block; /* Změněno z inline-block na block pro konzistenci */
            width: fit-content; /* Aby zabíralo jen potřebnou šířku */
            background-color: #4a4a4a;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 1.5rem;
            transition: background-color 0.2s ease;
        }
        .back-to-dashboard-link:hover {
            background-color: #6a6a6a;
        }
        .back-to-dashboard-link:focus {
            outline: 2px solid #facc15;
            outline-offset: 2px;
        }
        /* Styly pro input typu file */
        label.file-input-label {
            display: inline-flex; /* Aby se chovalo jako tlačítko */
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            color: #000;
            background-color: #ffc107; /* Import barva */
        }
        label.file-input-label:hover {
            opacity: 0.9;
        }
        label.file-input-label input[type="file"] {
            display: none; /* Skryje samotný input file */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Odkaz zpět na Dashboard -->
        <a href="../../../index.html" class="back-to-dashboard-link" aria-label="Zpět na hlavní dashboard JSM">← Zpět na Dashboard</a>

        <h1 id="mainTitle">Osobní záznamník</h1>
        <!-- Globální Export/Import -->
        <!-- ODSTRANĚNA TŘÍDA 'form-section', aby se tlačítka neschovávala -->
        <div class="flex items-center justify-between mb-6" id="globalControls">
            <button class="btn-export" onclick="exportAllData()">Exportovat vše (JSON)</button>
            <label class="ml-4 btn-import"> <!-- Přidána třída btn-import pro lepší vzhled -->
                Importovat vše (JSON):
                <input type="file" onchange="importAllData(event)" accept=".json" aria-label="Vybrat soubor pro import dat"/>
            </label>
        </div>

        <div class="flex flex-wrap justify-center mb-6" id="addButtonsSection">
            <button class="btn-toggle-form" onclick="toggleForm('noteFormSection')" aria-controls="noteFormSection" aria-expanded="false">Přidat poznámku</button>
            <button class="btn-toggle-form" onclick="toggleForm('todoListFormSection')" aria-controls="todoListFormSection" aria-expanded="false">Přidat To-Do List</button>
            <button class="btn-toggle-form" onclick="toggleForm('eventFormSection')" aria-controls="eventFormSection" aria-expanded="false">Přidat událost</button>
            <button class="btn-toggle-form" onclick="toggleForm('ideaFormSection')" aria-controls="ideaFormSection" aria-expanded="false">Přidat nápad</button>
        </div>

        <div id="noteFormSection" class="form-section hidden">
            <h2>Přidat poznámku</h2>
            <label for="noteTitle">Název poznámky:</label>
            <input type="text" id="noteTitle" placeholder="Např. Důležité myšlenky před spaním" aria-label="Název poznámky" />
            <label for="noteText">Text poznámky:</label>
            <textarea id="noteText" placeholder="Sem napište text poznámky..." aria-label="Text poznámky"></textarea>
            <button class="btn-primary" onclick="addNote()">Přidat poznámku</button>
        </div>

        <div id="todoListFormSection" class="form-section hidden">
            <h2>Přidat nový To-Do List</h2>
            <label for="newListName">Název listu:</label>
            <input type="text" id="newListName" placeholder="Např. Nákup, Domácí práce, Osobní projekty" aria-label="Název To-Do listu" />
            <button class="btn-primary" onclick="addTodoList()">Vytvořit list</button>
        </div>

        <div id="todoFormSection" class="form-section hidden">
            <h2 id="todoFormSectionTitle">Přidat úkol do listu</h2>
            <label for="taskText">Popis úkolu:</label>
            <input type="text" id="taskText" placeholder="Např. Koupit mléko, Zaplatit složenky" aria-label="Popis úkolu" />
            <label for="taskDueDate">Termín (datum):</label>
            <input type="date" id="taskDueDate" aria-label="Termín úkolu" />
            <label for="taskPriority">Priorita:</label>
            <select id="taskPriority" aria-label="Priorita úkolu">
                <option value="nízká">Nízká</option>
                <option value="střední">Střední</option>
                <option value="vysoká">Vysoká</option>
            </select>
            <button class="btn-primary" onclick="addTask()">Přidat úkol</button>
        </div>
        
        <div id="eventFormSection" class="form-section hidden">
            <h2>Přidat událost</h2>
            <label for="eventDate">Datum události:</label>
            <input type="date" id="eventDate" aria-label="Datum události" />
            <label for="eventTime">Čas události:</label>
            <input type="time" id="eventTime" aria-label="Čas události" />
            <label for="eventTitle">Název události:</label>
            <input type="text" id="eventTitle" placeholder="Např. Kontrola u endokrinologa, Narozeniny babičky" aria-label="Název události" />
            <label for="eventDescription">Popis události / Poznámky:</label>
            <textarea id="eventDescription" placeholder="Detailní popis události..." aria-label="Popis události"></textarea>
            <button class="btn-primary" onclick="addEvent()">Přidat událost</button>
        </div>

        <div id="ideaFormSection" class="form-section hidden">
            <h2>Přidat nápad</h2>
            <label for="ideaTitle">Název nápadu:</label>
            <input type="text" id="ideaTitle" placeholder="Např. Nový recept na večeři, Vylepšení herního PC" aria-label="Název nápadu" />
            <label for="ideaDescription">Popis nápadu / detailní poznámky:</label>
            <textarea id="ideaDescription" placeholder="Rozveďte svůj nápad..." aria-label="Popis nápadu"></textarea>
            <label for="ideaCategory">Kategorie nápadu:</label>
            <select id="ideaCategory" aria-label="Kategorie nápadu">
                <option value="Obecné">Obecné</option>
                <option value="Zdraví">Zdraví a wellness</option>
                <option value="Hobby">Hobby a zájmy</option>
                <option value="Domácnost">Domácnost</option>
                <option value="Cestování">Cestování</option>
                <option value="Vzdělávání">Vzdělávání</option>
                <option value="AI_Tech">AI a technologie</option>
                <option value="Ostatní">Ostatní</option>
            </select>
            <button class="btn-primary" onclick="addIdea()">Přidat nápad</button>
        </div>

        <div class="filter-section">
            <label for="globalFilterInput" class="sr-only">Filtruj záznamy:</label>
            <input type="text" id="globalFilterInput" placeholder="Filtruj záznamy (název, popis, termín, kategorie...)" oninput="updateTable()" aria-label="Filtrovat záznamy" />
            <button class="btn-filter" onclick="clearFilter()">Zrušit filtr</button>
        </div>

        <table id="mainDataTable">
            <thead>
                <tr>
                    <th scope="col">Typ</th>
                    <th scope="col">Název/Popis</th>
                    <th scope="col">Detail/Termín</th>
                    <th scope="col">Kategorie/Priorita</th>
                    <th scope="col">Akce</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <!-- Modální okno pro zprávy a potvrzení (sjednoceno s ostatními aplikacemi) -->
        <div id="customMessageModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessageTitle" tabindex="-1">
            <div class="modal-content">
                <h3 id="modalMessageTitle" class="text-xl font-bold text-yellow-300 mb-4">Zpráva</h3>
                <p id="modalMessage" class="text-gray-300 mb-4"></p>
                <div class="modal-buttons text-right">
                    <button id="modalCancelButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md ml-2 hidden">Zrušit</button>
                    <button id="modalOkButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">OK</button>
                </div>
            </div>
        </div>
        
        <div id="todoListDetailSection" class="hidden container-fluid bg-gray-900 p-8 rounded-lg shadow-lg text-left text-gray-200 mb-12">
            <a href="../../../index.html" onclick="goBackToMainView()" class="back-to-dashboard-link mb-6" aria-label="Zpět na hlavní přehled záznamníku">← Zpět na hlavní přehled</a>
            <h2 id="currentTodoListName"></h2>
            <div id="todoListTasksTableContainer">
                <table id="todoListTasksTable">
                    <thead>
                        <tr>
                            <th scope="col">Splněno</th>
                            <th scope="col">Popis úkolu</th>
                            <th scope="col">Termín</th>
                            <th scope="col">Priorita</th>
                            <th scope="col">Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <div class="text-center mt-6">
                <button class="btn-primary" onclick="showAddTodoTaskForm()">Přidat nový úkol do listu</button>
            </div>
        </div>

    <script>
        // Hlavní datová struktura pro všechny typy záznamů
        let data = {
            notes: [],
            todos: [], // Pole pro To-Do listy, každý list je { id, name, tasks: [] }
            events: [],
            ideas: []
        };

        let currentView = 'main'; // 'main' nebo 'todoListDetail'
        let currentTodoListId = null; // ID aktuálně zobrazeného To-Do listu

        // --- Funkce pro zobrazení/skrytí modálního okna ---
        let lastFocusedElement = null; // Pro udržení fokusu pro přístupnost

        function showCustomModal(message, title = 'Zpráva', onConfirm = null, showCancel = false) {
            lastFocusedElement = document.activeElement; // Uložíme aktuálně fokusovaný prvek
            
            const modal = document.getElementById('customMessageModal');
            document.getElementById('modalMessageTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message; // Použijeme innerHTML pro vložení HTML obsahu (např. formulářů)
            modal.style.display = 'flex'; // Zobrazíme modal
            
            const okButton = document.getElementById('modalOkButton');
            okButton.textContent = 'OK'; 
            okButton.onclick = () => { 
                closeCustomModal(); 
                if (onConfirm) onConfirm(); 
            };
            
            let cancelButton = document.getElementById('modalCancelButton');
            if (cancelButton) { // Zkontrolujeme, zda tlačítko existuje
                cancelButton.style.display = showCancel ? 'inline-block' : 'none';
                cancelButton.onclick = closeCustomModal; // Zavře modal na Zrušit
            }

            modal.focus(); 
            modal.setAttribute('aria-hidden', 'false');
            document.addEventListener('keydown', handleModalKeyboard);
        }

        function closeCustomModal() {
            document.getElementById('customMessageModal').style.display = 'none'; // Skryjeme modal
            document.getElementById('customMessageModal').setAttribute('aria-hidden', 'true');
            document.removeEventListener('keydown', handleModalKeyboard);
            if (lastFocusedElement) {
                lastFocusedElement.focus();
            }
        }

        function handleModalKeyboard(event) {
            if (event.key === 'Escape') {
                closeCustomModal();
            }
        }

        // Pomocná funkce pro formátování data (DD.MM.YYYY na YYYY-MM-DD pro input type="date")
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateString;
        }

        // Pomocná funkce pro parsování data (YYYY-MM-DD z input type="date" na DD.MM.YYYY pro uložení)
        function parseDateFromInput(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-'); // Předpokládá YYYY-MM-DD
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            return dateString;
        }

        // Pomocná funkce pro získání "YYYY-MM" z data DD.MM.YYYY
        function getYearMonth(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}`;
            }
            return '';
        }

        // Pomocná funkce pro získání "YYYY" z data DD.MM.YYYY
        function getYear(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('.');
            if (parts.length === 3) {
                return parts[2];
            }
            return '';
        }

        // --- Funkce pro přepínání viditelnosti formulářů (stejné jako v Centrálním záznamníku) ---
        let activeFormId = null;
        function toggleForm(formId) {
            const targetForm = document.getElementById(formId);
            if (activeFormId === formId) {
                targetForm.classList.add('hidden');
                document.querySelector(`button[aria-controls="${formId}"]`)?.setAttribute('aria-expanded', 'false');
                activeFormId = null;
            } else {
                document.querySelectorAll('.form-section').forEach(form => {
                    if (form.id !== formId) {
                        form.classList.add('hidden');
                        document.querySelector(`button[aria-controls="${form.id}"]`)?.setAttribute('aria-expanded', 'false');
                    }
                });
                targetForm.classList.remove('hidden');
                document.querySelector(`button[aria-controls="${formId}"]`)?.setAttribute('aria-expanded', 'true');
                activeFormId = formId;
                targetForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                targetForm.querySelector('input, textarea, select, button')?.focus();
            }
        }

        // --- Funkce pro rozbalování/sbalování sekcí s tabulkami ---
        function toggleTableSection(containerId, buttonId) {
            const container = document.getElementById(containerId);
            const button = document.getElementById(buttonId);

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                button.textContent = 'Sbalit';
                button.setAttribute('aria-expanded', 'true');
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                container.classList.add('hidden');
                button.textContent = 'Zobrazit';
                button.setAttribute('aria-expanded', 'false');
            }
        }


        // --- Funkce pro Poznámky ---
        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const text = document.getElementById('noteText').value.trim();

            if (!title || !text) { showCustomModal('Prosím, vyplňte název i text poznámky.', 'Chyba'); return; }
            data.notes.push({ id: Date.now(), type: 'note', title: title, text: text });
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteText').value = '';
            updateTable();
            toggleForm('noteFormSection'); // Skryje formulář po přidání
        }

        function viewNote(id) {
            const note = data.notes.find(n => n.id === id);
            showCustomModal(`
                <p class="modal-text"><strong>Text:</strong> ${note.text.replace(/\n/g, '<br>')}</p>
            `, `Poznámka: ${note.title}`, null, false); // Removed extra buttons, will be added by showCustomModal if needed
        }

        function editNote(id) {
            const note = data.notes.find(n => n.id === id);
            showCustomModal('Upravit poznámku', `
                <label for="editNoteTitle">Název poznámky:</label>
                <input type="text" id="editNoteTitle" value="${note.title}" placeholder="Název poznámky" /><br>
                <label for="editNoteText">Text poznámky:</label>
                <textarea id="editNoteText" placeholder="Poznámka">${note.text}</textarea>
            `, () => { submitEditNote(id); }, true);
        }

        function submitEditNote(id) {
            const note = data.notes.find(n => n.id === id);
            note.title = document.getElementById('editNoteTitle').value.trim();
            note.text = document.getElementById('editNoteText').value.trim();
            closeCustomModal();
            updateTable();
        }

        // --- Funkce pro To-Do Listy (nová struktura) ---
        function showTodoListDetails(listId) {
            currentView = 'todoListDetail';
            currentTodoListId = listId;
            
            // Skryjeme hlavní UI elementy
            document.getElementById('globalControls').classList.add('hidden');
            document.getElementById('addButtonsSection').classList.add('hidden');
            document.getElementById('globalFilterInput').classList.add('hidden');
            document.querySelector('.filter-section button')?.classList.add('hidden'); // Optional chaining for safety
            document.getElementById('mainDataTable').classList.add('hidden');
            
            // Zobrazíme detail To-Do listu
            const list = data.todos.find(l => l.id === listId);
            document.getElementById('currentTodoListName').textContent = `Úkoly v listu: ${list ? list.name : ''}`;
            document.getElementById('todoListDetailSection').classList.remove('hidden');
            
            updateTasksTable(); // Zobrazí úkoly pro vybraný list
            // Po otevření detailu listu zobrazíme formulář pro přidání úkolu do něj
            document.getElementById('todoFormSection').classList.remove('hidden');
            document.getElementById('todoFormSectionTitle').textContent = `Přidat úkol do listu "${list ? list.name : ''}"`;
            document.getElementById('taskText').focus(); // Zaměření na první input
        }

        function goBackToMainView() {
            currentView = 'main';
            currentTodoListId = null;

            // Znovu zobrazíme hlavní UI elementy
            document.getElementById('globalControls').classList.remove('hidden');
            document.getElementById('addButtonsSection').classList.remove('hidden');
            document.getElementById('globalFilterInput').classList.remove('hidden');
            document.querySelector('.filter-section button')?.classList.remove('hidden'); // Optional chaining for safety
            document.getElementById('mainDataTable').classList.remove('hidden');

            document.getElementById('todoListDetailSection').classList.add('hidden');
            document.getElementById('todoFormSection').classList.add('hidden'); // Skrýt formulář pro přidání úkolu
            
            updateTable(); // Znovu zobrazí všechny záznamy v hlavní tabulce
        }
        
        function addTodoList() {
            const listName = document.getElementById('newListName').value.trim();
            if (!listName) { showCustomModal('Prosím, zadejte název To-Do listu.', 'Chyba'); return; }
            data.todos.push({ id: Date.now(), type: 'todo_list', name: listName, tasks: [] });
            document.getElementById('newListName').value = '';
            updateTable();
            toggleForm('todoListFormSection'); // Skryje formulář po přidání
        }

        function showAddTodoTaskForm() {
            // Funkce pro zobrazení formuláře pro přidání úkolu (pokud není viditelný)
            toggleForm('todoFormSection');
            // Zajištění, že se formulář zaměří
            document.getElementById('taskText').focus();
        }

        function addTask() {
            const text = document.getElementById('taskText').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;

            if (!text) { showCustomModal('Prosím, vyplňte popis úkolu.', 'Chyba'); return; }
            if (currentTodoListId === null) { showCustomModal('Nejdříve musíte vybrat nebo vytvořit To-Do list.', 'Chyba'); return; }

            const list = data.todos.find(l => l.id === currentTodoListId);
            if (list) {
                list.tasks.push({ id: Date.now(), type: 'todo_task', text: text, dueDate: dueDate, priority: priority, completed: false });
                document.getElementById('taskText').value = '';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskPriority').value = 'nízká';
                updateTasksTable(); // Aktualizuje jen úkoly v listu
                toggleForm('todoFormSection'); // Skryje formulář po přidání úkolu
            }
        }

        function toggleTaskCompletionInList(taskId) { // Změněno z index na ID
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (list) {
                const task = list.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    updateTasksTable();
                }
            }
        }

        function editTaskInList(taskId) { // Změněno z index na ID
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (!list) return;
            const task = list.tasks.find(t => t.id === taskId);
            if (!task) return;

            showCustomModal(`
                <label for="editTaskText">Popis úkolu:</label>
                <input type="text" id="editTaskText" value="${task.text}" placeholder="Popis úkolu" /><br>
                <label for="editTaskDueDate">Termín (datum):</label>
                <input type="date" id="editTaskDueDate" value="${task.dueDate}" /><br>
                <label for="editTaskPriority">Priorita:</label>
                <select id="editTaskPriority">
                    <option value="nízká" ${task.priority === 'nízká' ? 'selected' : ''}>Nízká</option>
                    <option value="střední" ${task.priority === 'střední' ? 'selected' : ''}>Střední</option>
                    <option value="vysoká" ${task.priority === 'vysoká' ? 'selected' : ''}>Vysoká</option>
                </select>
            `, 'Upravit úkol', () => { submitEditTaskInList(taskId); }, true);
        }

        function submitEditTaskInList(taskId) { // Změněno z index na ID
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (!list) return;
            const task = list.tasks.find(t => t.id === taskId);
            if (!task) return;

            task.text = document.getElementById('editTaskText').value.trim();
            task.dueDate = document.getElementById('editTaskDueDate').value;
            task.priority = document.getElementById('editTaskPriority').value;
            closeCustomModal();
            updateTasksTable();
        }

        function deleteTaskInList(taskId) { // Změněno z index na ID
            confirmAndDeleteItem('todo_task', taskId, currentTodoListId); // Voláme potvrzovací modal
        }

        function updateTasksTable() { // Zobrazuje úkoly pro aktuálně vybraný To-Do list
            const tbody = document.querySelector('#todoListTasksTable tbody'); 
            tbody.innerHTML = '';
            
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (!list) return; 

            const tasks = list.tasks.sort((a, b) => {
                // Nesplněné před splněnými, pak priorita (vysoká -> nízká), pak termín
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                const priorityOrder = { 'vysoká': 3, 'střední': 2, 'nízká': 1 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) return priorityOrder[b.priority] - priorityOrder[a.priority];
                return (a.dueDate || '').localeCompare(b.dueDate || '') || (a.text || '').toLowerCase().localeCompare(b.text || '').toLowerCase();
            });

            tasks.forEach(task => {
                const row = document.createElement('tr');
                const completedClass = task.completed ? 'todo-completed' : '';
                const priorityClass = `todo-priority-${task.priority}`;
                
                row.innerHTML = `
                    <td class="${completedClass}">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onclick="toggleTaskCompletionInList(${task.id})">
                    </td>
                    <td class="${completedClass}">${task.text}</td>
                    <td class="${completedClass}">${formatDateForDisplay(task.dueDate)}</td>
                    <td class="${completedClass} ${priorityClass}">${task.priority}</td>
                    <td>
                        <button class="btn-secondary" onclick="editTaskInList(${task.id})">Upravit</button>
                        <button class="btn-danger" onclick="deleteTaskInList(${task.id})">Smazat</button>
                        <button class="btn-export" onclick="exportItemToTxt('todo_task', ${task.id})">Export TXT</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Funkce pro úpravu názvu To-Do listu
        function editTodoListName(listId) {
            const list = data.todos.find(l => l.id === listId);
            if (!list) return;

            showCustomModal('Upravit název To-Do listu', `
                <label for="editListName">Název listu:</label>
                <input type="text" id="editListName" value="${list.name}" placeholder="Název To-Do listu" /><br>
            `, () => { submitEditTodoListName(listId); }, true);
        }

        function submitEditTodoListName(listId) {
            const list = data.todos.find(l => l.id === listId);
            if (!list) return;
            list.name = document.getElementById('editListName').value.trim();
            closeCustomModal();
            updateTable(); // Aktualizujeme hlavní tabulku, kde se zobrazují názvy listů
        }


        // --- Funkce pro Plánovač událostí ---
        function addEvent() {
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();

            if (!date || !time || !title) { showCustomModal('Prosím, vyplňte Datum, Čas a Název události.', 'Chyba'); return; }
            data.events.push({ id: Date.now(), type: 'event', date: date, time: time, title: title, description: description });
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            updateTable();
            toggleForm('eventFormSection');
        }

        function viewEvent(id) {
            const event = data.events.find(e => e.id === id);
            showCustomModal(`
                <p class="modal-text"><strong>Datum:</strong> ${formatDateForDisplay(event.date)}</p>
                <p class="modal-text"><strong>Čas:</strong> ${event.time}</p>
                <p class="modal-text"><strong>Popis:</strong> ${event.description.replace(/\n/g, '<br>')}</p>
            `, `Událost: ${event.title}`, null, false);
        }

        function editEvent(id) {
            const event = data.events.find(e => e.id === id);
            showCustomModal('Upravit událost', `
                <label for="editEventDate">Datum události:</label>
                <input type="date" id="editEventDate" value="${event.date}" /><br>
                <label for="editEventTime">Čas události:</label>
                <input type="time" id="editEventTime" value="${event.time}" /><br>
                <label for="editEventTitle">Název události:</label>
                <input type="text" id="editEventTitle" value="${event.title}" placeholder="Název události" /><br>
                <label for="editEventDescription">Popis události / Poznámky:</label>
                <textarea id="editEventDescription" placeholder="Popis události / Poznámky">${event.description}</textarea>
            `, () => { submitEditEvent(id); }, true);
        }

        function submitEditEvent(id) {
            const event = data.events.find(e => e.id === id);
            event.date = document.getElementById('editEventDate').value;
            event.time = document.getElementById('editEventTime').value;
            event.title = document.getElementById('editEventTitle').value.trim();
            event.description = document.getElementById('editEventDescription').value.trim();
            closeCustomModal();
            updateTable();
        }

        // --- Funkce pro Nápady ---
        function addIdea() {
            const title = document.getElementById('ideaTitle').value.trim();
            const description = document.getElementById('ideaDescription').value.trim();
            const category = document.getElementById('ideaCategory').value;

            if (!title || !description) { showCustomModal('Prosím, vyplňte název i popis nápadu.', 'Chyba'); return; }
            data.ideas.push({ id: Date.now(), type: 'idea', title: title, description: description, category: category });
            document.getElementById('ideaTitle').value = '';
            document.getElementById('ideaDescription').value = '';
            document.getElementById('ideaCategory').value = 'Obecné';
            updateTable();
            toggleForm('ideaFormSection');
        }

        function viewIdea(id) {
            const idea = data.ideas.find(i => i.id === id);
            showCustomModal(`
                <p class="modal-text"><strong>Popis:</strong> ${idea.description.replace(/\n/g, '<br>')}</p>
            `, `Nápad: ${idea.title} (${idea.category})`, null, false);
        }

        function editIdea(id) {
            const idea = data.ideas.find(i => i.id === id);
            showCustomModal('Upravit nápad', `
                <label for="editIdeaTitle">Název nápadu:</label>
                <input type="text" id="editIdeaTitle" value="${idea.title}" placeholder="Název nápadu" /><br>
                <label for="editIdeaDescription">Popis nápadu / detailní poznámky:</label>
                <textarea id="editIdeaDescription" placeholder="Popis nápadu / detailní poznámky">${idea.description}</textarea><br>
                <label for="editIdeaCategory">Kategorie nápadu:</label>
                <select id="editIdeaCategory">
                    <option value="Obecné" ${idea.category === 'Obecné' ? 'selected' : ''}>Obecné</option>
                    <option value="Zdraví" ${idea.category === 'Zdraví' ? 'selected' : ''}>Zdraví a wellness</option>
                    <option value="Hobby" ${idea.category === 'Hobby' ? 'selected' : ''}>Hobby a zájmy</option>
                    <option value="Domácnost" ${idea.category === 'Domácnost' ? 'selected' : ''}>Domácnost</option>
                    <option value="Cestování" ${idea.category === 'Cestování' ? 'selected' : ''}>Cestování</option>
                    <option value="Vzdělávání" ${idea.category === 'Vzdělávání' ? 'selected' : ''}>Vzdělávání</option>
                    <option value="AI_Tech" ${idea.category === 'AI_Tech' ? 'selected' : ''}>AI a technologie</option>
                    <option value="Ostatní" ${idea.category === 'Ostatní' ? 'selected' : ''}>Ostatní</option>
                </select>
            `, () => { submitEditIdea(id); }, true);
        }

        function submitEditIdea(id) {
            const idea = data.ideas.find(i => i.id === id);
            idea.title = document.getElementById('editIdeaTitle').value.trim();
            idea.description = document.getElementById('editIdeaDescription').value.trim();
            idea.category = document.getElementById('editIdeaCategory').value;
            closeCustomModal();
            updateTable();
        }

        // --- Globální funkce pro správu dat a tabulky ---
        // Nahrazuje confirm() vlastním modalem
        function confirmAndDeleteItem(type, id, todoListId = null) {
            showCustomModal('Opravdu chcete odstranit tento záznam?', 'Potvrdit smazání', () => {
                doDeleteItem(type, id, todoListId);
            }, true); // showCancel = true pro potvrzovací modal
        }

        // Skutečná funkce pro smazání po potvrzení
        function doDeleteItem(type, id, todoListId = null) {
            if (type === 'todo_task' && todoListId !== null) { // Úkol v rámci listu
                const list = data.todos.find(list => list.id === todoListId);
                if (list) {
                    list.tasks = list.tasks.filter(task => task.id !== id);
                    updateTasksTable(); // Aktualizuje tabulku úkolů v listu
                }
            } else { // Ostatní typy nebo celé To-Do listy
                // Speciální zacházení pro odstranění celého todo_listu
                if (type === 'todo_list') {
                    data.todos = data.todos.filter(item => item.id !== id);
                } else { // Pro notes, events, ideas
                    data[type + 's'] = data[type + 's'].filter(item => item.id !== id);
                }
            }
            closeCustomModal(); 
            updateTable(); // Aktualizuje hlavní tabulku
        }

        // Globální filtr a aktualizace tabulky
        function updateTable() {
            // Pokud jsme v detailu konkrétního To-Do listu, aktualizujeme jen jeho úkoly
            if (currentView === 'todoListDetail') {
                updateTasksTable();
                return;
            }

            const tbody = document.querySelector('#mainDataTable tbody');
            tbody.innerHTML = '';
            const filterInput = document.getElementById('globalFilterInput').value.toLowerCase();

            // Získání a sloučení všech záznamů
            let allItems = [];
            // Přidáme Poznámky, Události, Nápady
            allItems = allItems.concat(data.notes.map(n => ({ ...n, displayType: 'Poznámka' })));
            allItems = allItems.concat(data.events.map(e => ({ ...e, displayType: 'Událost' })));
            allItems = allItems.concat(data.ideas.map(i => ({ ...i, displayType: 'Nápad' })));
            
            // Přidáme To-Do LISTY, ne jednotlivé úkoly do globálního přehledu
            // U To-Do listů počítáme úkoly pro zobrazení
            allItems = allItems.concat(data.todos.map(list => ({ 
                id: list.id, 
                type: 'todo_list', 
                name: list.name, 
                taskCount: list.tasks.length, 
                displayType: 'To-Do List' 
            })));


            // Filtrování záznamů
            const filteredItems = allItems.filter(item => {
                // Přizpůsobení vyhledávání pro různé typy
                const searchable = (item.title || item.text || item.name || '') + ' ' + // Název/Popis/Jméno listu
                                   (item.description || '') + ' ' +
                                   (item.category || '') + ' ' +
                                   (item.priority || '') + ' ' +
                                   (item.dueDate || item.date || '') + ' ' +
                                   (item.time || '');
                return searchable.toLowerCase().includes(filterInput);
            });

            // Rozdělení a seřazení podle typu
            const notes = filteredItems.filter(item => item.type === 'note').sort((a, b) => (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase()));
            const todoLists = filteredItems.filter(item => item.type === 'todo_list').sort((a, b) => (a.name || '').toLowerCase().localeCompare((b.name || '').toLowerCase()));
            const events = filteredItems.filter(item => item.type === 'event').sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.time}`);
                const dateTimeB = new Date(`${b.date}T${b.time}`);
                return dateTimeA - dateTimeB;
            });
            const ideas = filteredItems.filter(item => item.type === 'idea').sort((a, b) => (a.category || '').toLowerCase().localeCompare((b.category || '').toLowerCase()) || (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase()));

            // Spojení v požadovaném pořadí: Poznámky, To-Do Listy, Události, Nápady
            const finalSortedItems = [...notes, ...todoLists, ...events, ...ideas];

            // Vytvoření řádků tabulky
            finalSortedItems.forEach(item => {
                const row = document.createElement('tr');
                let cell1 = '', cell2 = '', cell3 = '', cell4 = '', actionButtons = ''; 

                // Přizpůsobení obsahu buněk podle typu záznamu
                switch (item.type) {
                    case 'note':
                        cell1 = `<span class="item-type-note">${item.displayType}</span>`;
                        cell2 = `<button class="text-left" onclick="viewNote(${item.id})">${item.title}</button>`;
                        cell3 = item.text.substring(0, 50) + (item.text.length > 50 ? '...' : ''); // Zkrácený text
                        cell4 = '---';
                        actionButtons = `
                            <button class="btn-secondary" onclick="editItem('${item.type}', ${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('${item.type}', ${item.id})">Smazat</button>
                            <button class="btn-export" onclick="exportItemToTxt('${item.type}', ${item.id})">Export TXT</button>
                        `;
                        break;
                    case 'todo_list': // Speciální typ pro To-Do listy v hlavním přehledu
                        cell1 = `<span class="item-type-todo_list">${item.displayType}</span>`;
                        cell2 = `<button class="text-left" onclick="showTodoListDetails(${item.id})">${item.name}</button>`;
                        cell3 = `${item.taskCount} úkolů`;
                        cell4 = '---';
                        actionButtons = `
                            <button class="btn-secondary" onclick="editTodoListName(${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('todo_list', ${item.id})">Smazat</button>
                        `;
                        break;
                    case 'event':
                        cell1 = `<span class="item-type-event">${item.displayType}</span>`;
                        cell2 = `<button class="text-left" onclick="viewEvent(${item.id})">${item.title}</button>`;
                        cell3 = `${formatDateForDisplay(item.date)} ${item.time}`;
                        cell4 = item.description.substring(0, 50) + (item.description.length > 50 ? '...' : ''); // Zkrácený popis
                        actionButtons = `
                            <button class="btn-secondary" onclick="editItem('${item.type}', ${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('${item.type}', ${item.id})">Smazat</button>
                            <button class="btn-export" onclick="exportItemToTxt('${item.type}', ${item.id})">Export TXT</button>
                        `;
                        break;
                    case 'idea':
                        cell1 = `<span class="item-type-idea">${item.displayType}</span>`;
                        cell2 = `<button class="text-left" onclick="viewIdea(${item.id})">${item.title}</button>`;
                        cell3 = item.description.substring(0, 50) + (item.description.length > 50 ? '...' : ''); // Zkrácený popis
                        cell4 = item.category;
                        actionButtons = `
                            <button class="btn-secondary" onclick="editItem('${item.type}', ${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('${item.type}', ${item.id})">Smazat</button>
                            <button class="btn-export" onclick="exportItemToTxt('${item.type}', ${item.id})">Export TXT</button>
                        `;
                        break;
                }

                row.innerHTML = `
                    <td>${cell1}</td>
                    <td>${cell2}</td>
                    <td>${cell3}</td>
                    <td>${cell4}</td>
                    <td>${actionButtons}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Globální funkce pro editaci (otevře správný modal podle typu)
        function editItem(type, id) {
            switch (type) {
                case 'note': editNote(id); break;
                case 'todo_list': editTodoListName(id); break; // Upravit název listu
                case 'todo_task': editTaskInList(id); break; // Upravit úkol v listu
                case 'event': editEvent(id); break;
                case 'idea': editIdea(id); break;
            }
        }

        // Globální funkce pro export jednotlivých položek do TXT
        function exportItemToTxt(type, id) {
            let item, content = '';
            let filename = 'zaznam';

            switch (type) {
                case 'note':
                    item = data.notes.find(n => n.id === id);
                    if (!item) return;
                    content = `--- Poznámka ---\nNázev: ${item.title}\nText: ${item.text}\n`;
                    filename = item.title;
                    break;
                case 'todo_task': // Export jednotlivého úkolu z listu
                    const list = data.todos.find(l => l.tasks.some(t => t.id === id));
                    item = list ? list.tasks.find(t => t.id === id) : null;
                    if (!item) return;
                    content = `--- Úkol (To-Do) ---\nList: ${list.name}\nPopis: ${item.text}\nTermín: ${formatDateForDisplay(item.dueDate)}\nPriorita: ${item.priority}\nSplněno: ${item.completed ? 'Ano' : 'Ne'}\n`;
                    filename = item.text;
                    break;
                case 'event':
                    item = data.events.find(e => e.id === id);
                    if (!item) return;
                    content = `--- Událost ---\nNázev: ${item.title}\nDatum: ${formatDateForDisplay(item.date)}\nČas: ${item.time}\nPopis: ${item.description}\n`;
                    filename = item.title;
                    break;
                case 'idea':
                    item = data.ideas.find(i => i.id === id);
                    if (!item) return;
                    content = `--- Nápad/Inspirace ---\nNázev: ${item.title}\nKategorie: ${item.category}\nPopis: ${item.description}\n`;
                    filename = item.title;
                    break;
                default: return;
            }
            
            // Odstranění nepovolených znaků pro název souboru
            filename = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();

            const dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(content);
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `${filename}_${type}_${id}.txt`);
            dl.click();
        }

        function clearFilter() {
            document.getElementById('globalFilterInput').value = '';
            updateTable();
        }

        // Globální export všech dat
        function exportAllData() {
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2)); // Přidáno null, 2 pro formátování
                const dl = document.createElement('a');
                dl.setAttribute("href", dataStr);
                dl.setAttribute("download", "osobni_zaznamnik.json"); // Změna názvu souboru
                dl.click();
                showCustomModal("Všechna data osobního záznamníku byla úspěšně exportována jako JSON.", "Export dokončen");
            } catch (error) {
                console.error("Chyba při exportu JSON dat:", error);
                showCustomModal("Nastala chyba při exportu dat. Zkuste to prosím znovu.", 'Chyba exportu');
            }
        }

        // Globální import všech dat
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Základní kontrola formátu (ponecháváme flexibilní pro starší soubory)
                    if (importedData && typeof importedData === 'object' &&
                        'notes' in importedData && Array.isArray(importedData.notes) &&
                        'todos' in importedData && Array.isArray(importedData.todos) &&
                        'events' in importedData && Array.isArray(importedData.events) &&
                        'ideas' in importedData && Array.isArray(importedData.ideas)) {
                        
                        // Zajistíme, že id jsou čísla a boolean hodnoty jsou správné pro todos
                        importedData.notes.forEach(item => item.id = Number(item.id) || Date.now());
                        importedData.todos.forEach(list => {
                            list.id = Number(list.id) || Date.now();
                            list.tasks.forEach(task => {
                                task.id = Number(task.id) || Date.now();
                                task.completed = (task.completed === true); // Zajistí boolean
                                if (typeof task.dueDate !== 'string') task.dueDate = '';
                                if (typeof task.priority !== 'string') task.priority = 'nízká';
                            });
                        });
                        importedData.events.forEach(item => item.id = Number(item.id) || Date.now());
                        importedData.ideas.forEach(item => item.id = Number(item.id) || Date.now());

                        data = importedData;
                        updateTable();
                        showCustomModal('Data byla úspěšně importována do osobního záznamníku!', "Import dokončen"); // Změna textu
                    } else {
                        showCustomModal('Chyba: Importovaný soubor nemá očekávaný formát pro osobní záznamník.', 'Chyba importu'); // Změna textu
                    }
                } catch (e) {
                    console.error("Chyba při importu JSON souboru:", e);
                    showCustomModal('Chyba při čtení JSON souboru: ' + e.message, 'Chyba importu');
                }
            };
            reader.readAsText(file);
        }

        // Pomocná funkce pro formátování data pro zobrazení
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        }

        // Počáteční zobrazení tabulky při načtení stránky
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializace event listeneru pro tlačítko OK modalu
            document.getElementById('modalOkButton').addEventListener('click', closeCustomModal);
            // Zajištění, že tlačítko Zrušit funguje
            const cancelButton = document.getElementById('modalCancelButton');
            if (cancelButton) {
                cancelButton.addEventListener('click', closeCustomModal);
            }
            // Zajištění, že se modal zavře i při stisku Escape
            document.getElementById('customMessageModal').addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeCustomModal();
            });

            updateTable();
        });
    </script>
</body>
</html>
